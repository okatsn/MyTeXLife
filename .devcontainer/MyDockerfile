# FROM qmcgaw/latexdevcontainer:latest
FROM qmcgaw/latexdevcontainer:latest-full
# KEYNOTE: Very likely everything is set up with `USER root` in `FROM qmcgaw/latexdevcontainer:latest`.

RUN apt-get update && apt-get -y install \
    libfontconfig libfontconfig1 \
    ghostscript \
    sudo \
    curl

    # libfontconfig1 is for ... I don't know. But without it, my LaTeX compliation failed
    # ghostscript for handling eps image files
    # inkscape is for including svg; but ["The smoothest route"](https://danmackinlay.name/notebook/latex.html#svg) that converts SVG into PDF+TeX seems very unsuitable for submitting to an academic journal.


# # FIX PERMISSION
# Previously, I cannot move/delete files in the project in /projects via neither windows file explorer nor vscode WSL interface. Accesses are denied because project are `git cloned` by `root`, not the user `okatsn` (the user of WSL).
#
# ## How I fixed it
# Refering https://hub.docker.com/r/jupyter/base-notebook/dockerfile, I create a new user with its ID the default ID (i.e., "1000"), and use the `fix-permissions` script to change the modification permissions of everything under the "/workspace" folder

## Only root can chmod files/directories that are accessible only to root
USER root


## Copy the file ".devcontainer/fix-permissions" to local machine for later call
# - also see https://www.cnblogs.com/sparkdev/p/9573248.html for "building context"
COPY fix-permissions /usr/local/bin/fix-permissions
RUN chmod a+rx /usr/local/bin/fix-permissions


ARG NB_USER="jovyan"
ARG NB_UID="1000"
ARG NB_GID="100"

## Backslash does matter!
# - "workspace": relative directory
# - "/workspace": absolute directory
# - "/workspace/" can be wrong but I'm not very sure
ARG WORKSPACE_DIR="/workspace/dir/defined/in/docker-compose/yml"


## Configure environment
ENV NB_USER=$NB_USER \
    NB_UID=$NB_UID \
    NB_GID=$NB_GID\
    WORKSPACE_DIR=$WORKSPACE_DIR

## Add user $NB_USER with its group being $NB_GID
# RUN useradd -g $NB_GID $NB_USER

## Add user as in jupyter/base-notebook/
RUN useradd -m -s /bin/bash -N -u $NB_UID $NB_USER

## Make $NB_USER a sudoer
RUN usermod -aG sudo $NB_USER

## ERROR will occur if:
# - Without `mkdir /home/$NB_USER`: Permission denied after switch to USER $NB_UID when making "home/jovyan" (jovyan cannot modify the "home" folder!).
# - Without `chown $NB_USER:$NB_GID /home/$NB_USER`, subdirectories for vscode cannot be created because "/home/$NB_USER" is created and only owned by root.
RUN chown $NB_USER:$NB_GID $WORKSPACE_DIR && \
    fix-permissions $WORKSPACE_DIR && \
    mkdir /home/$NB_USER && \
    fix-permissions /home/$NB_USER
    # or `chown $NB_USER:$NB_GID /home/$NB_USER`

## Switch to user
USER $NB_UID


WORKDIR $WORKSPACE_DIR
## Install Starship
RUN sh -c "$(sudo curl -fsSL https://starship.rs/install.sh)" -- -y \
    && echo 'eval "$(starship init bash)"' >> ~/.bashrc \
    && mkdir -p ~/.config \
    && echo -e '[conda]\nsymbol = "Conda "\nignore_base = false' > ~/.config/starship.toml
